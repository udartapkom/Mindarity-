#!/bin/bash

# ðŸ” Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð´Ð»Ñ Mindarity
# ÐÐ²Ñ‚Ð¾Ñ€: Mindarity Team
# Ð’ÐµÑ€ÑÐ¸Ñ: 1.0

set -e

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
DOMAIN="mindarity.ru"
WWW_DOMAIN="www.mindarity.ru"
EMAIL="admin@mindarity.ru"
SSL_DIR="/opt/mindarity/ssl"
LETSENCRYPT_DIR="/etc/letsencrypt"

echo "ðŸ” ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð´Ð»Ñ $DOMAIN..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [[ $EUID -ne 0 ]]; then
   echo "âŒ Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root"
   exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
if [[ -z "$DOMAIN" ]]; then
    echo "âŒ ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð´Ð¾Ð¼ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ DOMAIN"
    exit 1
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot..."
apt update
apt install -y certbot python3-certbot-nginx

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ SSL
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ SSL..."
mkdir -p $SSL_DIR
chmod 700 $SSL_DIR

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
if lsof -Pi :80 -sTCP:LISTEN -t >/dev/null ; then
    echo "âš ï¸  ÐŸÐ¾Ñ€Ñ‚ 80 Ð·Ð°Ð½ÑÑ‚. ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ nginx Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹"
    echo "ðŸ’¡ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸:"
    echo "   systemctl stop nginx"
    echo "   docker-compose down"
    read -p "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
fi

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo "ðŸŽ« ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."
certbot certonly \
    --standalone \
    --preferred-challenges http \
    --email $EMAIL \
    --agree-tos \
    --no-eff-email \
    -d $DOMAIN \
    -d $WWW_DOMAIN

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."
cp $LETSENCRYPT_DIR/live/$DOMAIN/fullchain.pem $SSL_DIR/
cp $LETSENCRYPT_DIR/live/$DOMAIN/privkey.pem $SSL_DIR/

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
chmod 600 $SSL_DIR/*
chown -R $SUDO_USER:$SUDO_USER $SSL_DIR

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
echo "ðŸ”„ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."
cat > /etc/cron.d/mindarity-ssl-renew << EOF
# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Mindarity
0 12 * * * root /usr/bin/certbot renew --quiet --deploy-hook "systemctl reload nginx"
EOF

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
cat > $SSL_DIR/renew-certs.sh << 'EOF'
#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²

DOMAIN="mindarity.ru"
SSL_DIR="/opt/mindarity/ssl"
LETSENCRYPT_DIR="/etc/letsencrypt"

echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
certbot renew --quiet

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
cp $LETSENCRYPT_DIR/live/$DOMAIN/fullchain.pem $SSL_DIR/
cp $LETSENCRYPT_DIR/live/$DOMAIN/privkey.pem $SSL_DIR/

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
chmod 600 $SSL_DIR/*
chown -R $SUDO_USER:$SUDO_USER $SSL_DIR

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° nginx (ÐµÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½)
if docker ps | grep -q mindarity-nginx; then
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° nginx..."
    docker exec mindarity-nginx nginx -s reload
fi

echo "âœ… SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
EOF

chmod +x $SSL_DIR/renew-certs.sh

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."
openssl x509 -in $SSL_DIR/fullchain.pem -text -noout | grep -E "Subject:|Not Before|Not After"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
echo "ðŸ§ª Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°..."
cat > /tmp/nginx-test.conf << EOF
server {
    listen 443 ssl;
    server_name $DOMAIN;
    
    ssl_certificate $SSL_DIR/fullchain.pem;
    ssl_certificate_key $SSL_DIR/privkey.pem;
    
    location / {
        return 200 "SSL Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!";
        add_header Content-Type text/plain;
    }
}
EOF

echo "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
echo ""
echo "ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°Ñ…:"
echo "- Ð”Ð¾Ð¼ÐµÐ½: $DOMAIN"
echo "- WWW Ð´Ð¾Ð¼ÐµÐ½: $WWW_DOMAIN"
echo "- Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹: $SSL_DIR/"
echo "- ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾ (ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 12:00)"
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²:"
echo "openssl x509 -in $SSL_DIR/fullchain.pem -text -noout"
echo ""
echo "ðŸ”„ Ð ÑƒÑ‡Ð½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:"
echo "$SSL_DIR/renew-certs.sh"
echo ""
echo "ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Certbot:"
echo "https://certbot.eff.org/docs/"
echo ""
echo "âš ï¸  Ð’Ð°Ð¶Ð½Ð¾:"
echo "- Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑŽÑ‚ÑÑ"
echo "- Ð¥Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸ Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸"
echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ ÑÑ€Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²"
